hsI = matrix( rep(0, nsim*d$GI), ncol=d$GI ),
hsJ = matrix( rep(0, nsim*d$GJ), ncol=d$GJ ),
sA = rexp( n=nsim, rate=1/5 ),
sK = rep(0, nsim),
mu_e = rep(0, 4),
rho_e = diag(4)
)
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
# test
observed_data = comparison_data$d_obs
prior_pred = ITCJ_prior
type='individual'
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
observed_data$OR
# test
observed_data = comparison_data$d_obs
prior_pred = ITCJ_prior
type='individual'
# true data
observed_data_mom = observed_data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
observed_data_mom$OR = prior_pred$expected$OR
sim_summary = summary_data( observed_data=observed_data_mom, type=type)
sim_summary
# test
observed_data = comparison_data$d_obs
prior_pred = ITCJ_prior
type='individual'
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
observed_data$OR = prior_pred$expected$OR
sim_summary = summary_data( observed_data=observed_data_mom, type=type)
dsum = cbind(dsum, pE=sim_summary$p)
dsum
# test
observed_data = comparison_data$d_obs
prior_pred = ITCJ_prior
type='individual'
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
# Expected value
{
observed_data$OR = prior_pred$expected$OR
sim_summary = summary_data( observed_data=observed_data_mom, type=type)
dsum = cbind(dsum, pE=sim_summary$p)
}
dsum
# simulated data
for( n in 1:dim(prior_pred$full_distr$OR)[1] ){
observed_data$OR = prior_pred$full_distr$OR[n,]
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, p=sim_summary$p)
}
names(dsum)
names(dsum)[6:ncol(dsum)] = paste0('p', 1:dim(prior_pred$full_distr$OR)[1])
dsum = dsum[order(dsum$p, decreasing=T),]
dsum
str(dsum)
# plot
with(
dsum,
{
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
points( 1:nrow(dsum), pE, pch=19, col=rgb(0,0,0,1))
points( 1:nrow(dsum), p, pch=19, col=rgb(1,0,0,0.8))
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=c(p_lower[i],p_upper[i]), col=rgb(1,0,0,0.8) ) } )
legend( 'topleft', pch=rep(19, 2), col=c(rgb(1,0,0,0.8), col_sim), bty='n',
legend=c('Observed data','Simulated data') )
}
)
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
col_sim = rgb(0,0,1,0.05)
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
points( 1:nrow(dsum), pE, pch=19, col=rgb(0,0,0,1))
points( 1:nrow(dsum), dsum$pE, pch=19, col=rgb(0,0,0,1))
points( 1:nrow(dsum), p, pch=19, col=rgb(1,0,0,0.8))
points( 1:nrow(dsum), dsum$p, pch=19, col=rgb(1,0,0,0.8))
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=c(p_lower[i],p_upper[i]), col=rgb(1,0,0,0.8) ) } )
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=with(dsum, c(p_lower[i],p_upper[i])), col=rgb(1,0,0,0.8) ) } )
legend( 'topleft', pch=rep(19,3), col=c(rgb(1,0,0,0.8),rgb(0,0,0,1), col_sim), bty='n',
legend=c('Observed data','Expected value','Full distribution') )
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
points( 1:nrow(dsum), dsum$pE, pch=19, col=rgb(0,0,0,1))
points( 1:nrow(dsum), dsum$p, pch=19, col=rgb(1,0,0,0.8))
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=with(dsum, c(p_lower[i],p_upper[i])), col=rgb(1,0,0,0.8) ) } )
legend( 'topleft', pch=rep(19,3), col=c(rgb(1,0,0,0.8),rgb(0,0,0,1),rgb(0,0,1,0.4)), bty='n',
legend=c('Observed data','Expected value','Full distribution') )
# preliminar ####
rm(list=ls()); gc(); old_par=par()
## packages ####
librerias = c('tidyverse','cmdstanr')
sapply(librerias, require, character.only=T)
# sapply(librerias, install.packages, character.only=T)
## user defined functions ####
dir = '/home/josema/Desktop/1. Work/1 research/PhD Antwerp/#thesis/paper3/paper3_manuscript'
source( file.path( dir, '1_code', 'udf.R' ) )
# Preparing data ####
load( file=file.path( dir,'2_data','comparison_data_train.Rdata' ) )
d = model_dlist( observed_data = comparison_data$d_obs )
# str(d)
print('4_1_1 ITCJ analysis: data preparation complete')
# Modeling ####
## prior predictive ####
nsim = 100
ITCJ_prior = ITCJ_predictive_check(
parameter = 'OR',
dlist = d,
nsim = nsim,
bXAc = rep(0, nsim),
bXAd = matrix( rep(0, nsim*d$GA), ncol=d$GA ),
bXIc = rep(0, nsim),
bXId = matrix( rep(0, nsim*d$GI), ncol=d$GI ),
bZKc = rep(0, nsim),
bZKd = matrix( rep(0, nsim*d$GK), ncol=d$GK ),
bZJc = rep(0, nsim),
bZJd = matrix( rep(0, nsim*d$GJ), ncol=d$GJ ),
hsI = matrix( rep(0, nsim*d$GI), ncol=d$GI ),
hsJ = matrix( rep(0, nsim*d$GJ), ncol=d$GJ ),
sA = rexp( n=nsim, rate=1/5 ),
sK = rep(0, nsim),
mu_e = rep(0, 4),
rho_e = diag(4)
)
save( ITCJ_prior, row.names=F,
file=file.path( dir,'3_results','ITCJ_analysis','fit','4_1_1_ITCJ_prior.Rdata' ) )
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
png(file=file.path( dir,'3_results','ITCJ_analysis','figures','4_1_1_ITCJ_prior_confusion.png' ),
width=25, height=15, units='cm', res=200)
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
dev.off()
predictive_check_wins_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
type='stimulus',
col_sim = rgb(0,0,1,0.05))
# preliminar ####
rm(list=ls()); gc(); old_par=par()
## packages ####
librerias = c('tidyverse','cmdstanr')
sapply(librerias, require, character.only=T)
# sapply(librerias, install.packages, character.only=T)
## user defined functions ####
dir = '/home/josema/Desktop/1. Work/1 research/PhD Antwerp/#thesis/paper3/paper3_manuscript'
source( file.path( dir, '1_code', 'udf.R' ) )
# Preparing data ####
load( file=file.path( dir,'2_data','comparison_data_train.Rdata' ) )
d = model_dlist( observed_data = comparison_data$d_obs )
# str(d)
print('4_1_1 ITCJ analysis: data preparation complete')
# Modeling ####
## prior predictive ####
nsim = 100
ITCJ_prior = ITCJ_predictive_check(
parameter = 'OR',
dlist = d,
nsim = nsim,
bXAc = rep(0, nsim),
bXAd = matrix( rep(0, nsim*d$GA), ncol=d$GA ),
bXIc = rep(0, nsim),
bXId = matrix( rep(0, nsim*d$GI), ncol=d$GI ),
bZKc = rep(0, nsim),
bZKd = matrix( rep(0, nsim*d$GK), ncol=d$GK ),
bZJc = rep(0, nsim),
bZJd = matrix( rep(0, nsim*d$GJ), ncol=d$GJ ),
hsI = matrix( rep(0, nsim*d$GI), ncol=d$GI ),
hsJ = matrix( rep(0, nsim*d$GJ), ncol=d$GJ ),
sA = rexp( n=nsim, rate=1/5 ),
sK = rep(0, nsim),
mu_e = rep(0, 4),
rho_e = diag(4)
)
save( ITCJ_prior, row.names=F,
file=file.path( dir,'3_results','ITCJ_analysis','fit','4_1_1_ITCJ_prior.Rdata' ) )
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
png(file=file.path( dir,'3_results','ITCJ_analysis','figures','4_1_1_ITCJ_prior_confusion.png' ),
width=25, height=15, units='cm', res=200)
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
dev.off()
predictive_check_wins_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
type='stimulus',
col_sim = rgb(0,0,1,0.05) )
#' Plot for ITCJ analysis predictive checks
#'
#' @param observed_data
#' @param prior_pred
#' @param type
#'
#' @return plot
#' @export
#'
#' @examples
predictive_check_wins_plot = function( observed_data,
prior_pred,
type='individual',
col_sim){
# # test
# observed_data = comparison_data$d_obs
# prior_pred = ITCJ_prior
# type='individual'
# col_sim = rgb(0,0,1,0.05)
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
# Expected value
{
observed_data$OR = prior_pred$expected$OR
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, pE=sim_summary$p)
}
# Full distribution
{
# simulated data
for( n in 1:dim(prior_pred$full_distr$OR)[1] ){
observed_data$OR = prior_pred$full_distr$OR[n,]
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, p=sim_summary$p)
}
names(dsum)[6:ncol(dsum)] = paste0('p', 1:dim(prior_pred$full_distr$OR)[1])
dsum = dsum[order(dsum$p, decreasing=T),]
}
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
points( 1:nrow(dsum), dsum$pE, pch=19, col=rgb(0,0,0,1))
points( 1:nrow(dsum), dsum$p, pch=19, col=rgb(1,0,0,0.5))
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=with(dsum, c(p_lower[i],p_upper[i])), col=rgb(1,0,0,0.5) ) } )
legend( 'topleft', pch=rep(19,3), col=c(rgb(1,0,0,0.5),rgb(0,0,0,1),rgb(0,0,1,0.4)), bty='n',
legend=c('Observed data','Expected value','Full distribution') )
}
predictive_check_wins_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
type='stimulus',
col_sim = rgb(0,0,1,0.05) )
#' Plot for ITCJ analysis predictive checks
#'
#' @param observed_data
#' @param prior_pred
#' @param type
#'
#' @return plot
#' @export
#'
#' @examples
predictive_check_wins_plot = function( observed_data,
prior_pred,
type='individual',
col_sim){
# # test
# observed_data = comparison_data$d_obs
# prior_pred = ITCJ_prior
# type='individual'
# col_sim = rgb(0,0,1,0.05)
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
# Expected value
{
observed_data$OR = prior_pred$expected$OR
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, pE=sim_summary$p)
}
# Full distribution
{
# simulated data
for( n in 1:dim(prior_pred$full_distr$OR)[1] ){
observed_data$OR = prior_pred$full_distr$OR[n,]
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, p=sim_summary$p)
}
names(dsum)[6:ncol(dsum)] = paste0('p', 1:dim(prior_pred$full_distr$OR)[1])
dsum = dsum[order(dsum$p, decreasing=T),]
}
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
points( 1:nrow(dsum), dsum$pE, pch=19, col=rgb(1,0,0,0.8))
points( 1:nrow(dsum), dsum$p, pch=19, col=rgb(0,0,0,1))
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=with(dsum, c(p_lower[i],p_upper[i])), col=rgb(1,0,0,0.8) ) } )
legend( 'topleft', pch=rep(19,3), col=c(rgb(0,0,0,1),rgb(1,0,0,0.8),rgb(0,0,1,0.4)), bty='n',
legend=c('Observed data','Expected value','Full distribution') )
}
predictive_check_wins_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
type='stimulus',
col_sim = rgb(0,0,1,0.05) )
#' @examples
#' Plot for ITCJ analysis predictive checks
#'
#' @param observed_data
#' @param prior_pred
#' @param type
#'
#' @return plot
#' @export
#'
#' @examples
predictive_check_wins_plot = function( observed_data,
prior_pred,
type='individual',
col_sim){
# # test
# observed_data = comparison_data$d_obs
# prior_pred = ITCJ_prior
# type='individual'
# col_sim = rgb(0,0,1,0.05)
# true data
obs_summary = summary_data( observed_data=observed_data, type=type)
dsum = obs_summary[,c('name','p','p_lower','p_upper')]
# Expected value
{
observed_data$OR = prior_pred$expected$OR
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, pE=sim_summary$p)
}
# Full distribution
{
# simulated data
for( n in 1:dim(prior_pred$full_distr$OR)[1] ){
observed_data$OR = prior_pred$full_distr$OR[n,]
sim_summary = summary_data( observed_data=observed_data, type=type)
dsum = cbind(dsum, p=sim_summary$p)
}
names(dsum)[6:ncol(dsum)] = paste0('p', 1:dim(prior_pred$full_distr$OR)[1])
dsum = dsum[order(dsum$p, decreasing=T),]
}
# plot
plot( NULL, xlab=type, ylab='Win probability',
xlim = c(1,nrow(dsum)), ylim = c(0,1.2), xaxt='n' )
sapply( 6:ncol(dsum),
function(i){ points( 1:nrow(dsum), dsum[,i], pch=19, col=col_sim ) } )
points( 1:nrow(dsum), dsum$pE, pch=19, col=rgb(1,0,0,0.8))
points( 1:nrow(dsum), dsum$p, pch=19, col=rgb(0,0,0,1))
sapply(
1:nrow(dsum),
function(i){ lines( x=rep(i,2), y=with(dsum, c(p_lower[i],p_upper[i])), col=rgb(0,0,0,0.8) ) } )
legend( 'topleft', pch=rep(19,3), col=c(rgb(0,0,0,1),rgb(1,0,0,0.8),rgb(0,0,1,0.4)), bty='n',
legend=c('Observed data','Expected value','Full distribution') )
}
predictive_check_wins_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
type='stimulus',
col_sim = rgb(0,0,1,0.05) )
#' Plot for ITCJ analysis predictive checks (confusion matrix)
#'
#' @param observed_data
#' @param prior_pred
#' @param type
#'
#' @return plot
#' @export
#'
#' @examples
predictive_check_confusion_plot = function( observed_data,
prior_pred,
col_sim){
# # test
# observed_data = comparison_data$d_obs
# prior_pred = ITCJ_prior
# col_sim = rgb(0,0,1,0.05)
# Expected value
{
dmom = data.frame( true=observed_data$OR, pred=prior_pred$expected$OR)
confusion_mat = table(dmom)
confusion_mat = confusion_mat/rowSums(confusion_mat)
confusion_mat_E = data.frame(confusion_mat)
}
# Full distribution
{
dmom = data.frame( true=observed_data$OR, pred=prior_pred$full_distr$OR[1,])
confusion_mat = table(dmom)
confusion_mat = confusion_mat/rowSums(confusion_mat)
confusion_mat = data.frame(confusion_mat)
for( n in 2:dim(prior_pred$full_distr$OR)[1] ){
dmom = data.frame( true=observed_data$OR, pred=prior_pred$full_distr$OR[n,])
confusion_mom = table(dmom)
confusion_mom = confusion_mom/rowSums(confusion_mom)
confusion_mom = data.frame(confusion_mom)
confusion_mat = cbind(confusion_mat, confusion_mom$Freq)
}
names(confusion_mat)[3:ncol(confusion_mat)] = paste0('p', 1:dim(prior_pred$full_distr$OR)[1])
}
# plot
plot( NULL, xlab='Proportion', ylab='', xlim=c(0,1), ylim=c(1,4), yaxt='n' )
axis( side=2, at=1:4, labels=c('TN','FN','FP','TP'), las=2 )
abline( h=1:4, lty=2, col=rgb(0,0,0,0.5) )
for( i in 3:ncol(confusion_mat)){
points( confusion_mat[,i], 1:nrow(confusion_mat), pch=19, col=col_sim )
}
points( confusion_mat_E[,3], 1:nrow(confusion_mat_E), pch=19, col=rgb(0,0,0,1) )
legend('left', legend=c('Expected value','Full distribution'), bty='n',
pch=c(19,19), col=c(rgb(1,0,0,0.8), rgb(0,0,1,0.4)))
}
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
#' Plot for ITCJ analysis predictive checks (confusion matrix)
#'
#' @param observed_data
#' @param prior_pred
#' @param type
#'
#' @return plot
#' @export
#'
#' @examples
predictive_check_confusion_plot = function( observed_data,
prior_pred,
col_sim){
# # test
# observed_data = comparison_data$d_obs
# prior_pred = ITCJ_prior
# col_sim = rgb(0,0,1,0.05)
# Expected value
{
dmom = data.frame( true=observed_data$OR, pred=prior_pred$expected$OR)
confusion_mat = table(dmom)
confusion_mat = confusion_mat/rowSums(confusion_mat)
confusion_mat_E = data.frame(confusion_mat)
}
# Full distribution
{
dmom = data.frame( true=observed_data$OR, pred=prior_pred$full_distr$OR[1,])
confusion_mat = table(dmom)
confusion_mat = confusion_mat/rowSums(confusion_mat)
confusion_mat = data.frame(confusion_mat)
for( n in 2:dim(prior_pred$full_distr$OR)[1] ){
dmom = data.frame( true=observed_data$OR, pred=prior_pred$full_distr$OR[n,])
confusion_mom = table(dmom)
confusion_mom = confusion_mom/rowSums(confusion_mom)
confusion_mom = data.frame(confusion_mom)
confusion_mat = cbind(confusion_mat, confusion_mom$Freq)
}
names(confusion_mat)[3:ncol(confusion_mat)] = paste0('p', 1:dim(prior_pred$full_distr$OR)[1])
}
# plot
plot( NULL, xlab='Proportion', ylab='', xlim=c(0,1), ylim=c(1,4), yaxt='n' )
axis( side=2, at=1:4, labels=c('TN','FN','FP','TP'), las=2 )
abline( h=1:4, lty=2, col=rgb(0,0,0,0.5) )
for( i in 3:ncol(confusion_mat)){
points( confusion_mat[,i], 1:nrow(confusion_mat), pch=19, col=col_sim )
}
points( confusion_mat_E[,3], 1:nrow(confusion_mat_E), pch=19, col=rgb(1,0,0,0.8) )
legend('left', legend=c('Expected value','Full distribution'), bty='n',
pch=c(19,19), col=c(rgb(1,0,0,0.8), rgb(0,0,1,0.4)))
}
predictive_check_confusion_plot(
observed_data = comparison_data$d_obs,
prior_pred = ITCJ_prior,
col_sim = rgb(0,0,1,0.1) )
